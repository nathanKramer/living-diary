# Living Diary

An AI-powered memory companion that lives in Telegram. It remembers conversations, extracts key facts and diary entries, and recalls them naturally using vector search.

## Tech stack

- **TypeScript** (ESM, strict mode) with **pnpm**
- **grammY** — Telegram bot framework (polling mode)
- **Vercel AI SDK v6** (`ai` package) — multi-provider LLM access
- **@ai-sdk/anthropic** — Claude for conversation and extraction
- **@ai-sdk/openai** — OpenAI embeddings only (text-embedding-3-small, 1536 dims)
- **LanceDB** — embedded vector database (no server, file-backed in `data/`)
- **Apache Arrow** — schema definition for LanceDB tables
- **zod v4** — tool parameter schemas for AI SDK tool calling

## Architecture

```
src/
  index.ts              # Entry point — inits memory, persona, bot, command menu
  config.ts             # Env var loading with validation
  bot/index.ts          # grammY bot — auth, commands, message handler
  ai/
    index.ts            # generateDiaryResponse() — tool-calling LLM with 4 memory tools
    system-prompt.ts    # Base prompt + persona layering, injects today's date
    extract.ts          # Background memory extraction from user messages
    configure.ts        # /configure — generates persona from user description
  memory/index.ts       # MemoryStore class — LanceDB CRUD with vector dedup
  persona/index.ts      # Load/save persona config to data/persona.json
```

## Key design decisions

**Tool calling over hardcoded queries**: The AI has 4 tools (`search_memories`, `search_by_date`, `get_user_facts`, `get_recent_memories`) and decides which to call based on the conversation. Uses `stopWhen: stepCountIs(5)` for multi-step tool loops.

**AI SDK v6 specifics**: Tools use `inputSchema` (not `parameters`). Multi-step uses `stopWhen: stepCountIs(n)` (not `maxSteps`). The `tool()` helper is from `ai` package.

**Memory deduplication**: `addMemory()` checks cosine distance against existing memories before inserting. User facts threshold: 0.10 (aggressive). Diary entries: 0.05 (tighter). Returns `null` if duplicate.

**Multi-user**: Memories have a `userId` field. User facts are filtered to the current speaker. Diary entries are shared across all users (enables family context). Auth uses `ALLOWED_USER_IDS` (comma-separated).

**Configurable persona**: System prompt = base behavior + persona. Default is "personal diary companion". Users can `/configure` to change it (e.g. family diary, company KB). Persona is generated by Claude and saved to `data/persona.json`.

**Extraction pipeline**: Runs in background after each reply. Only feeds user messages (not AI responses) to avoid re-storing recalled memories. Extraction prompt instructs to only extract NEW information.

## Commands

`pnpm dev` — run with tsx watch
`pnpm build` — compile TypeScript
`pnpm start` — run compiled JS

## Environment variables

See `.env.example`. Required: `TELEGRAM_BOT_TOKEN`, `ANTHROPIC_API_KEY`, `OPENAI_API_KEY`, `ALLOWED_USER_IDS`.

## LanceDB schema

Table `memories`: `id` (string), `userId` (float64), `content` (string), `type` (string), `tags` (string, comma-separated), `timestamp` (float64), `vector` (float32[1536]).

Memory types: `diary_entry`, `user_fact`, `conversation_summary`, `reflection`.

Schema migration: `init()` checks for missing columns and recreates the table if needed (drops data — fine for dev).

## Remaining backlog

See `PLAN.md` for full details. Unimplemented:
- Proactive check-ins and reflections (node-cron scheduler)
- Deployment setup (Docker, process management)
- Safety guardrails and user commands (/forget, /export, /stats, /delete_all, /pause, /resume)
- Rich diary features (search command, timeline, mood tracking)
- Tests and documentation
